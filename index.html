<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Trilhas de Minas: Guia Interativo dos Parques Estaduais</title>
    <meta name="description" content="Guia e Diário de Bordo Digital para os Parques Estaduais de Minas Gerais. Crie seu carimbo, faça check-ins e explore o ecoturismo mineiro." />

    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@700;900&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* 1. Variáveis & Reset */
        :root {
            --color-primary: #17A589; /* Verde Floresta */
            --color-secondary: #0B6B9A; /* Azul Rio */
            --color-background: #F8F9FA;
            --color-text: #212529;
            --color-muted: #6C757D;
            --color-card: #FFFFFF;
            --color-shadow: rgba(23, 165, 137, 0.1);
            --border-radius-lg: 16px;
            --border-radius-sm: 8px;
            --font-family-header: 'Lato', sans-serif;
            --font-family-body: 'Open Sans', sans-serif;
        }

        *{box-sizing: border-box; margin: 0; padding: 0;}
        body {
            font-family: var(--font-family-body);
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 16px;
        }
        
        /* 2. Tipografia e Títulos */
        h1, h2, h3, h4 {
            font-family: var(--font-family-header);
            margin-bottom: 10px;
            color: var(--color-secondary);
        }
        h1 {font-size: 24px;}
        h2 {font-size: 20px;}
        h3 {font-size: 18px;}
        .text-muted {color: var(--color-muted); font-size: 14px;}

        /* 3. Componentes Básicos (Botões e Inputs) */
        .btn {
            padding: 10px 18px;
            border-radius: var(--border-radius-sm);
            border: 1px solid transparent;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 14px;
        }
        .btn-primary {
            background: var(--color-primary);
            color: var(--color-card);
            border-color: var(--color-primary);
        }
        .btn-primary:hover {
            background: #148f77;
        }
        .btn-secondary {
            background: var(--color-card);
            color: var(--color-primary);
            border-color: var(--color-primary);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        input[type="text"], input[type="file"], textarea {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius-sm);
            flex-grow: 1;
            font-family: var(--font-family-body);
        }

        /* 4. Header e Perfil (FAB) */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 16px;
        }
        .logo-box {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-icon {
            width: 40px; height: 40px;
            border-radius: 8px;
            background: var(--color-primary);
            color: var(--color-card);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
        }
        .profile-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--color-card);
            padding: 6px 10px 6px 6px;
            border-radius: 50px;
            box-shadow: 0 2px 5px var(--color-shadow);
            cursor: pointer;
        }
        .profile-avatar {
            width: 30px; height: 30px;
            border-radius: 50%;
            background: var(--color-secondary);
            color: var(--color-card);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
        }
        /* NOVO: Estilos para o Avatar no Header quando tem foto */
        .profile-avatar.has-image {
            font-size: 0; /* Esconde o emoji */
            background-image: var(--avatar-img); /* Variável setada no JS */
            background-size: cover;
            background-position: center;
        }
        .profile-name {font-weight: 700; font-size: 13px;}

        /* 5. Seção de Busca e Filtro */
        .search-area {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .filter-buttons {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        .filter-buttons .btn {
            flex-shrink: 0;
            background: #fff;
            color: var(--color-muted);
            border: 1px solid #ccc;
        }
        .filter-buttons .btn.active {
            background: var(--color-primary);
            color: var(--color-card);
            border-color: var(--color-primary);
        }

        /* 6. Lista de Parques (Grid) */
        .parks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        .park-card {
            background: var(--color-card);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: 0 4px 12px var(--color-shadow);
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .park-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px var(--color-shadow);
        }
        .card-thumb {
            height: 180px;
            overflow: hidden;
        }
        .card-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .card-content {
            padding: 15px;
        }
        .card-content h3 {
            margin-bottom: 5px;
            color: var(--color-primary);
        }
        .card-details {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--color-muted);
            margin-top: 8px;
        }

        /* 7. Modal (Diário de Bordo) */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: flex-end; /* Mobile-first: abre de baixo */
            z-index: 1000;
        }
        .modal.open {
            display: flex;
        }
        .modal-content {
            background: var(--color-card);
            width: 100%;
            max-width: 900px;
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
            padding: 20px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        @media (min-width: 768px) {
            .modal { align-items: center; } /* Desktop: abre no centro */
            .modal-content { border-radius: var(--border-radius-lg); animation: fadeIn 0.3s; }
            .park-details-grid {
                display: grid;
                grid-template-columns: 2fr 1fr; /* Conteúdo principal + Sidebar */
                gap: 30px;
            }
        }
        @keyframes slideIn {
            from {transform: translateY(100%);}
            to {transform: translateY(0);}
        }
        @keyframes fadeIn {
            from {opacity: 0; transform: scale(0.95);}
            to {opacity: 1; transform: scale(1);}
        }

        /* Detalhes do Modal */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-hero {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: var(--border-radius-sm);
            margin-bottom: 15px;
        }
        .gallery-strip {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .gallery-strip img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .gallery-strip img:hover {
            border-color: var(--color-primary);
        }
        .map-embed-box {
            height: 300px;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            border: 1px solid #ddd;
            margin-top: 10px;
        }
        .map-embed-box iframe {
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* Sidebar Social (Carimbo) */
        .sidebar-stamp {
            padding: 15px;
            border-radius: var(--border-radius-lg);
            background: #f0f7f5; /* Fundo suave para destaque */
        }
        .stamp-preview {
            text-align: center;
            margin: 15px 0;
        }
        .stamp-badge {
            width: 70px; height: 70px;
            background: var(--color-primary);
            color: var(--color-card);
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            font-weight: 700;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stamp-status {
            font-size: 13px;
            margin-top: 5px;
            color: var(--color-secondary);
            font-weight: 600;
        }
        .stamp-history {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 5px;
        }
        .history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 13px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 5px;
        }
        .history-item img {
            width: 50px;
            height: 35px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="logo-box">
                <div class="logo-icon">⛰️</div>
                <h1>Trilhas de Minas</h1>
            </div>
            <div id="profileBtn" class="profile-pill" onclick="openProfile()">
                <div id="avatarEl" class="profile-avatar">👣</div>
                <div class="profile-name" id="profileName">Visitante</div>
            </div>
        </header>

        <div class="search-area">
            <input type="text" id="q" placeholder="Buscar parque, cidade ou tipo de trilha..." />
            <button class="btn btn-primary" id="btnSearch">Buscar</button>
        </div>

        <div class="filter-buttons" id="parksFilters">
            <button class="btn active" data-filter="all">Todos os Parques</button>
            <button class="btn" data-filter="Fácil">Fácil 🟢</button>
            <button class="btn" data-filter="Médio">Médio 🟡</button>
            <button class="btn" data-filter="Difícil">Difícil 🔴</button>
            <button class="btn" data-filter="Cachoeira">Cachoeiras 💧</button>
            <button class="btn" data-filter="Gruta">Grutas 🦇</button>
        </div>

        <h2 style="margin-top: 20px;">Mapa da Aventura</h2>
        <p class="text-muted" style="margin-bottom: 15px;">Use este mapa interativo (Google My Maps) para planejar sua rota por Minas Gerais.</p>
        <div class="map-embed-box" style="height: 350px;">
            <iframe id="mapFrame" src="about:blank" allowfullscreen></iframe>
        </div>
        <div style="text-align: right; margin-top: 10px;">
            <button class="btn btn-secondary" id="useMyMapsBtn">Personalizar Mapa</button>
        </div>
        
        <h2 style="margin-top: 30px;">Próximos Destinos</h2>
        <div id="loadingMessage" class="text-muted" style="text-align: center; padding: 20px;">Carregando trilhas...</div>
        <div id="noResults" class="text-muted" style="text-align: center; padding: 20px; display:none;">Nenhuma trilha encontrada com seus filtros.</div>
        <div id="parksList" class="parks-grid">
            </div>
        
        <footer style="margin-top: 50px; text-align: center;" class="text-muted">
            <p>Trilhas de Minas © Protótipo Serverless | Desenvolvido com foco em performance e ecoturismo.</p>
        </footer>

    </div>

    <div id="modalProfile" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Seu Diário de Bordo</h3>
                <button class="btn btn-secondary" onclick="closeProfile()">Fechar</button>
            </div>
            
            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                <div class="stamp-badge" style="width: 80px; height: 80px; font-size: 40px;" id="pfAvatarBig">👣</div>
                <div style="flex-grow: 1;">
                    <p class="text-muted">Seu nome e avatar para o carimbo digital.</p>
                    <input type="text" id="pfName" placeholder="Seu Apelido de Aventureiro" style="margin-bottom: 8px;" />
                    <input type="text" id="pfCity" placeholder="Cidade (Opcional)" />
                    <input type="file" id="pfPhotoInput" accept="image/*" style="margin-bottom: 8px;" />
                    <img id="pfPhotoPreview" style="display:none; width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;" alt="Prévia da foto de perfil" />
<div class="input-group" style="margin-top: 10px; flex-wrap: wrap;">
    <button class="btn btn-primary" onclick="saveProfile()">Salvar Perfil</button>
    <button class="btn btn-secondary" onclick="exportProfile()">Exportar</button>
</div>
<h5 style="margin-top: 20px;">Escolha um Avatar Temático:</h5>
<div id="themedAvatarGallery" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalPark" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 id="parkTitle">Título do Parque</h2>
                    <p class="text-muted" id="parkMeta">Cidade | Dificuldade | Tempo Estimado</p>
                </div>
                <button class="btn btn-secondary" onclick="closePark()">Fechar</button>
            </div>
            
            <img id="parkHero" class="modal-hero" src="" alt="Imagem principal do parque">

            <div class="park-details-grid">
                <div>
                    <h4 style="margin-top: 20px;">Galeria de Imagens</h4>
                    <div id="parkGallery" class="gallery-strip"></div>

                    <h4>Sobre o Parque</h4>
                    <p class="text-muted" id="parkAbout"></p>              

                    <h4 style="margin-top: 20px;">Trilhas | Atrações</h4>
                    <p id="parkTrailsInfo" style="white-space: pre-wrap; margin-bottom: 10px;"></p>
                    <p class="text-muted" id="parkMapMsg">Mapa detalhado do parque. Ideal para ver trilhas e pontos de interesse.</p>
                    <div class="map-embed-box">
                        <iframe id="parkDetailMap" src="about:blank" title="Mapa do Parque"></iframe>
                    </div>
                </div>

                <div class="sidebar-stamp">
                    <h4>Carimbo Digital (Check-in)</h4>
                    <p class="text-muted">Gere seu carimbo personalizado com a foto da sua aventura para compartilhar nas redes sociais!</p>
                    
                    <div class="input-group" style="flex-direction: column;">
                        <input type="file" id="photoInput" accept="image/*" />
                        <span class="text-muted" id="errorStamp" style="color: #c0392b; display: none;"></span>
                        <div class="input-group" style="margin-bottom: 0;">
                            <button class="btn btn-primary" id="btnGenerate">Com sua foto no parque</button>
                            <button class="btn btn-secondary" id="btnQuick">Com imagem do parque</button>
                        </div>
                    </div>
                    
                    <h5 style="margin-top: 20px; color: var(--color-secondary);">Seu Último Check-in</h5>
                    <div class="stamp-preview">
                        <div class="stamp-badge" id="stampBadge">👣</div>
                        <p class="stamp-status" id="stampLabel">Nenhum check-in ainda.</p>
                    </div>

                    <h5 style="margin-top: 20px; color: var(--color-secondary);">Histórico de Carimbos</h5>
                    <div id="myStamps" class="stamp-history">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="canvas" style="display:none"></canvas>

<script>
    // Dados do Projeto - Simulação de JSON
    // **********************************************************************************
    // GUIA RÁPIDO PARA INSERÇÃO DE PARQUES:
    // 
    // 1. COMEÇA AQUI: {
    // 2. id:           'novo_parque', // (string, SEM ACENTOS, SEM ESPAÇOS - Ex: 'rio_doce')
    // 3. name:         'Nome Completo do Parque',
    // 4. city:         'Cidade Sede',
    // 5. difficulty:   'Fácil' | 'Médio' | 'Difícil', // Usado para filtro de cor principal
    // 6. time:         'Tempo Estimado (Ex: 3-4h)',
    // 7. tags:         ['Difícil', 'Cachoeira', 'Mirante'], // Tags usadas nos botões de filtro.
    // 8. hero:         'LINK_DA_FOTO_DE_CAPA_AQUI', // URL da imagem principal (card/modal)
    // 9. about:        'Descrição curta e atraente para o modal.',
    // 10. gallery:     ['LINK_FOTO_1', 'LINK_FOTO_2'], // URLs de miniaturas para a Galeria
    // 11. mapEmbedUrl: 'SUA_URL_DO_MY_MAPS_DE_TRILHAS_AQUI' // URL de incorporação do Google My Maps
    // 12. TERMINA AQUI: },
    // 
    // **********************************************************************************

    const RAW_PARKS_DATA = [
        // --- PARQUE 1: IBITIPOCA (Exemplo de Parque Difícil) ---
        { 
            id: 'ibitipoca', 
            name: 'Parque Estadual do Ibitipoca', 
            city: 'Lima Duarte e Santa Rita do Ibitipoca', 
            difficulty: 'Difícil', 
            time: '4-6h', 
            tags: ['Difícil', 'Cachoeira', 'Mirante'], 
            trails_info: `Circuito das Águas: Com 5,2km ida/volta e duração média de 5h, subidas e descidas íngremes. Ao longo da trilha existem mirantes que foram instalados como forma de promover segurança e conforto ao visitante, além de possibilitar a contemplação da paisagem. | Circuito do Pião: Este circuito possui um percurso longo, com aproximadamente 9,5km ida/volta e duração média de 6h, com muitas subidas e descidas íngremes. | Circuito Janela do Céu: Esse circuito tem o limite para receber até 240 visitantes ao dia. É um percurso mais longo, com 16km ida/volta, com subidas e decidas íngremes, que exige preparo físico por conta de sua duração. | Cachoeira dos Macacos: Perfeita para banho em águas | Cachoeira do Encanto Um refúgio natural para relaxar`,
            hero: 'https://sisema07.github.io/parquesdeminas/Ibitipoca.jpg',
            about: 'Localizado nos municípios de Lima Duarte e Santa Rita do Ibitipoca, fazendo divisa com Bias Fortes, o Parque Estadual do Ibitipoca é um dos mais famosos destinos de ecoturismo de Minas Gerais. Inserido no bioma Mata Atlântica, apresenta lagos, cachoeiras, grutas e mirantes impressionantes. Entre os atrativos principais estão a Ponte de Pedra, a Janela do Céu, o Pico do Pião e a Gruta dos Três Arcos. A biodiversidade local reúne espécies raras e ameaçadas. A visitação é controlada, com venda de ingressos online ou diretamente na bilheteria, garantindo preservação ambiental e qualidade da experiência. Suas trilhas bem estruturadas fazem do parque um destino ímpar para contato com a natureza, turismo de aventura e contemplação.',  
            gallery: ['https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=800', 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=800'], 
            mapEmbedUrl: 'https://expressinha.com/wp-content/uploads/2019/06/mapa-ibitipoca.jpg'
        },
        // --- PARQUE 2: SERRA DO CIPÓ (Exemplo de Parque Médio) ---
        { 
            id: 'cipo', 
            name: 'Parque Nacional da Serra do Cipó', 
            city: 'Serra do Cipó', 
            difficulty: 'Médio', 
            time: '2-8h', 
            tags: ['Médio', 'Cachoeira', 'Vegetação'], 
            hero: 'https://upload.wikimedia.org/wikipedia/commons/c/cc/Parque_Nacional_da_Serra_do_Cip%C3%B3.jpg', 
            about: 'Vasta área na Serra do Espinhaço, conhecida por suas imensas cachoeiras (como a Véu da Noiva) e a rica flora do Cerrado e Campos Rupestres.', 
            gallery: ['https://images.unsplash.com/photo-1499394153797-499f5d8f2b51?q=80&w=800', 'https://images.unsplash.com/photo-1517457813264-500e5728a306?q=80&w=800'], 
            mapEmbedUrl: 'SUA_URL_MYMAPS_CIPÓ_AQUI'
        },
        // --- PARQUE 3: SUMIDOURO (Exemplo de Parque Fácil com Gruta) ---
        { 
            id: 'sumidouro', 
            name: 'Parque Estadual do Sumidouro', 
            city: 'Lagoa Santa', 
            difficulty: 'Fácil', 
            time: '2h', 
            tags: ['Fácil', 'Gruta', 'Arqueologia'], 
            hero: 'https://images.unsplash.com/photo-1549414207-6955c45f4c58?q=80&w=800', 
            about: 'Combina história e natureza, abrigando a Gruta da Lapinha e vestígios arqueológicos de Luzia. Ideal para um passeio leve e cultural.', 
            gallery: ['https://images.unsplash.com/photo-1549414207-6955c45f4c58?q=80&w=800', 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=800'], 
            mapEmbedUrl: 'SUA_URL_MYMAPS_SUMIDOURO_AQUI'
        },
        // --- PARQUE 4: RIO DOCE (Novo Exemplo: Maior remanescente de Mata Atlântica) ---
        { 
            id: 'rio_doce', 
            name: 'Parque Estadual do Rio Doce', 
            city: 'Marliéria', 
            difficulty: 'Médio', 
            time: '3-5h', 
            tags: ['Médio', 'Lago', 'Mata Atlântica', 'Vida Selvagem'], 
            hero: 'https://images.unsplash.com/photo-1582260273766-3d2b27a3c3d5?q=80&w=800', 
            about: 'O maior remanescente de Mata Atlântica de Minas, famoso por seus lagos naturais e pela rica biodiversidade. Ótimo para observação de aves.', 
            gallery: ['https://images.unsplash.com/photo-1582260273766-3d2b27a3c3d5?q=80&w=800', 'https://images.unsplash.com/photo-1547781708-4179371d34c1?q=80&w=800'], 
            mapEmbedUrl: 'SUA_URL_MYMAPS_RIO_DOCE_AQUI'
        },
        // --- PARQUE 5: MANGABEIRAS (Novo Exemplo: Parque Urbano/Fácil) ---
        { 
            id: 'mangabeiras', 
            name: 'Parque das Mangabeiras', 
            city: 'Belo Horizonte', 
            difficulty: 'Fácil', 
            time: '1-2h', 
            tags: ['Fácil', 'Urbano', 'Mirante', 'Família'], 
            hero: 'https://images.unsplash.com/photo-1582260273766-3d2b27a3c3d5?q=80&w=800', 
            about: 'Localizado aos pés da Serra do Curral, este é um dos maiores e mais importantes parques urbanos do país, oferecendo vistas panorâmicas da cidade.', 
            gallery: ['https://images.unsplash.com/photo-1547781708-4179371d34c1?q=80&w=800', 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=800'], 
            mapEmbedUrl: 'SUA_URL_MYMAPS_MANGABEIRAS_AQUI'
        }
    ];
    let allParks = [];
    let currentFilter = 'all';

        // Elementos UI
        const parksList = document.getElementById('parksList');
        const loadingMessage = document.getElementById('loadingMessage');
        const noResults = document.getElementById('noResults');
        let currentPark = null;

        // Função de Carregamento (Simulado)
        function loadParks() {
            loadingMessage.style.display = 'block';
            return new Promise(resolve => {
                setTimeout(() => {
                    allParks = RAW_PARKS_DATA;
                    loadingMessage.style.display = 'none';
                    resolve(allParks);
                }, 500);
            });
        }

        // ------------------ RENDERIZAÇÃO E FILTROS ------------------

        function renderList(items) {
            parksList.innerHTML = '';
            noResults.style.display = items.length === 0 ? 'block' : 'none';

            items.forEach(p => {
                const el = document.createElement('div');
                el.className = 'park-card';
                el.dataset.id = p.id;
                el.innerHTML = `
                    <div class="card-thumb"><img src="${p.hero}" alt="Vista de ${p.name}" loading="lazy"></div>
                    <div class="card-content">
                        <h3>${p.name}</h3>
                        <p class="text-muted">${p.about.substring(0, 80)}...</p>
                        <div class="card-details">
                            <span>📍 ${p.city}</span>
                            <span>⏱️ ${p.time}</span>
                            <span>${p.difficulty}</span>
                        </div>
                    </div>
                `;
                el.addEventListener('click', () => openPark(p.id));
                parksList.appendChild(el);
            });
        }

        function doSearch() {
            const q = document.getElementById('q').value.toLowerCase().trim();
            let results = allParks;

            // 1. Filtro de Busca (Nome/Cidade)
            if (q) {
                results = results.filter(p => 
                    p.name.toLowerCase().includes(q) || 
                    p.city.toLowerCase().includes(q) ||
                    p.tags.some(tag => tag.toLowerCase().includes(q)) // Busca por Tags
                );
            }

            // 2. Filtro de Dificuldade/Tag (Botões)
            if (currentFilter !== 'all') {
                results = results.filter(p => p.tags.includes(currentFilter));
            }

            renderList(results);
        }

        // Configuração dos Listeners de Busca e Filtro
        document.getElementById('btnSearch').addEventListener('click', doSearch);
        document.getElementById('q').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') doSearch();
        });

        document.getElementById('parksFilters').querySelectorAll('.btn').forEach(b => {
            b.addEventListener('click', (e) => {
                // Atualiza o estado visual dos botões
                document.getElementById('parksFilters').querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
                e.currentTarget.classList.add('active');
                
                currentFilter = e.currentTarget.dataset.filter;
                doSearch();
            });
        });

        // ------------------ MODAL DE DETALHES DO PARQUE ------------------

        function openPark(id) {
            const p = allParks.find(x => x.id === id);
            if (!p) return;
            currentPark = p;
            localStorage.setItem('currentParkId', p.id); // Salva o ID para uso na finalização assíncrona

            // Preenche o Modal
            document.getElementById('parkTitle').textContent = p.name;
            document.getElementById('parkMeta').textContent = `${p.city} | ${p.difficulty} | ${p.time}`;
            document.getElementById('parkAbout').textContent = p.about;
            document.getElementById('parkHero').src = p.hero;
            document.getElementById('parkTrailsInfo').textContent = p.trails_info || 'Nenhuma informação de trilha detalhada disponível.';
            document.getElementById('parkDetailMap').src = p.mapEmbedUrl || 'about:blank';
            document.getElementById('parkMapMsg').textContent = p.mapEmbedUrl ? 'Visualize as rotas e planeje sua trilha.' : 'Nenhuma rota detalhada disponível. Exibindo mapa geral.';

            // Galeria interativa
            const gallery = document.getElementById('parkGallery');
            gallery.innerHTML = '';
            (p.gallery || []).forEach(u => {
                const img = document.createElement('img');
                img.src = u;
                img.alt = `Miniatura de ${p.name}`;
                img.addEventListener('click', () => document.getElementById('parkHero').src = u);
                gallery.appendChild(img);
            });

            document.getElementById('modalPark').classList.add('open');
            refreshMyStamps(); // Atualiza o histórico de carimbos
        }

        function closePark() {
            document.getElementById('modalPark').classList.remove('open');
        }

        // ------------------ PERFIL E LOCALSTORAGE ------------------

        const defaultProfile = { 
            name: 'Aventureiro', 
            city: '', 
            avatar: '📸', // Usa o ícone de foto como default para avatares baseados em imagem
            avatarImage: 'https://sisema07.github.io/parquesdeminas/avatar/Lobo-Guara.png' // Use um dos seus links aqui
        };

        function loadProfile() {
            const raw = localStorage.getItem('explorerProfile');
            if (raw) try { return JSON.parse(raw) } catch (e) { }
            return defaultProfile;
        }

        function saveProfileObj(profile) { 
            localStorage.setItem('explorerProfile', JSON.stringify(profile)); 
            applyProfile(); 
        }

        function applyProfile() {
            const p = loadProfile();
            const avatarEl = document.getElementById('avatarEl'); // Elemento no Header
            
            document.getElementById('profileName').textContent = p.name || 'Visitante';
            avatarEl.textContent = p.avatar || '👣';
            
            // Lógica para mostrar a imagem no header
            if (p.avatarImage) {
                avatarEl.style.setProperty('--avatar-img', `url(${p.avatarImage})`);
                avatarEl.classList.add('has-image');
            } else {
                avatarEl.style.setProperty('--avatar-img', 'none');
                avatarEl.classList.remove('has-image');
            }
            
            // Aplica o emoji/foto no modal (se já existir no DOM)
            if (document.getElementById('pfAvatarBig')) document.getElementById('pfAvatarBig').textContent = p.avatar || '📸';
            if (document.getElementById('stampBadge')) document.getElementById('stampBadge').textContent = p.avatar || '📸';
        }

        function openProfile() {
            const m = document.getElementById('modalProfile');
            m.classList.add('open');
            const p = loadProfile();
            document.getElementById('pfName').value = p.name !== 'Aventureiro' ? p.name : '';
            document.getElementById('pfCity').value = p.city || '';
            document.getElementById('pfAvatarBig').textContent = p.avatar || '📸';

            // Exibir prévia da imagem e esconder o emoji
            const previewEl = document.getElementById('pfPhotoPreview');
            if (p.avatarImage) {
                previewEl.src = p.avatarImage;
                previewEl.style.display = 'block';
                document.getElementById('pfAvatarBig').textContent = ''; // Esconde o emoji grande
            } else {
                previewEl.style.display = 'none';
                document.getElementById('pfAvatarBig').textContent = p.avatar || '📸'; // Mostra o ícone fallback
            }
            
            // Chama para desenhar a galeria de avatares temáticos
            renderThemedAvatars(); 
        }

        function closeProfile() {
            document.getElementById('modalProfile').classList.remove('open');
        }

        function saveProfile() {
            const name = document.getElementById('pfName').value.trim() || 'Aventureiro';
            const city = document.getElementById('pfCity').value.trim() || '';
            
            // Preserva a imagem e o avatar/emoji atual
            const currentProfile = loadProfile(); 
            const avatar = currentProfile.avatar || '📸';
            const avatarImage = currentProfile.avatarImage || null;
            
            saveProfileObj({ name, city, avatar, avatarImage }); // Salva todos os dados
            closeProfile();
        }
        
        function exportProfile() { /* Lógica de exportação mantida */ } 
        function importProfile() { /* Lógica de importação mantida */ } 
        applyProfile();

        // NOVO: Lista FIXA de avatares temáticos (use emojis ou URLs)
        const THEMED_AVATARS = [
            { type: 'image', value: 'https://sisema07.github.io/parquesdeminas/avatar/Lobo-Guara.png', name: 'Lobo-Guará' },
            { type: 'image', value: 'https://sisema07.github.io/parquesdeminas/avatar/Macaco-Barbado.png', name: 'Macaco Barbado' },
            { type: 'image', value: 'https://sisema07.github.io/parquesdeminas/avatar/Macaco-Barbado2.png', name: 'Macaco Barbado2' },
            { type: 'image', value: 'https://sisema07.github.io/parquesdeminas/avatar/Onça-parda.png', name: 'Onça-parda' },
            { type: 'image', value: 'https://sisema07.github.io/parquesdeminas/avatar/jaguatirica2.png', name: 'Jaguatirica' }
        ];

        // NOVO: Função para renderizar a galeria e adicionar listeners
        function renderThemedAvatars() {
            const gallery = document.getElementById('themedAvatarGallery');
            if (!gallery) return;
            
            gallery.innerHTML = ''; // Limpa a galeria
            
            THEMED_AVATARS.forEach(avatar => {
                const el = document.createElement('div');
                el.style.width = '40px';
                el.style.height = '40px';
                el.style.borderRadius = '50%';
                el.style.background = 'var(--color-secondary)';
                el.style.color = 'var(--color-card)';
                el.style.display = 'flex';
                el.style.justifyContent = 'center';
                el.style.alignItems = 'center';
                el.style.fontSize = '22px';
                el.style.cursor = 'pointer';
                el.style.border = '2px solid transparent';
                el.title = avatar.name; // Dica de nome
                
                if (avatar.type === 'emoji') {
                    el.textContent = avatar.value;
                } else if (avatar.type === 'image') {
                    // Se for imagem, usa background-image para exibir a foto
                    el.style.backgroundImage = `url(${avatar.value})`;
                    el.style.backgroundSize = 'cover';
                    el.style.backgroundPosition = 'center'; // Adicionado para centralizar a imagem
                    el.textContent = '';
                }

                // Adiciona o evento de clique para seleção
                el.addEventListener('click', () => selectThemedAvatar(avatar));
                gallery.appendChild(el);
            });
        }

        // NOVO: Função para aplicar o avatar selecionado
        function selectThemedAvatar(avatar) {
            // 1. Desativa a foto de perfil (se houver)
            const p = loadProfile();
            p.avatarImage = null; 
            
            // 2. Define o novo avatar (emoji ou imagem)
            if (avatar.type === 'emoji') {
                p.avatar = avatar.value;
            } else {
                // Se for imagem, define um emoji padrão (ex: 📸) e salva a URL na imagem
                p.avatar = '📸'; 
                p.avatarImage = avatar.value;
            }
            
            // 3. Salva e atualiza o perfil em todos os lugares
            saveProfileObj(p);
            
            // 4. Reabre o modal para atualizar a visualização corretamente
            openProfile(); 
        }

        // Lógica para carregar a imagem de perfil e converter para Base64
        function handleAvatarUpload() {
            const file = document.getElementById('pfPhotoInput').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result; // Imagem em Base64
                
                const p = loadProfile();
                p.avatarImage = imageData;
                p.avatar = '📸'; // Usa um emoji de câmera para indicar que há uma foto
                saveProfileObj(p);
                
                // Atualiza o modal de perfil
                const previewEl = document.getElementById('pfPhotoPreview');
                previewEl.src = imageData;
                previewEl.style.display = 'block';
                document.getElementById('pfAvatarBig').textContent = ''; 

                // Limpa o input file para permitir novo upload
                document.getElementById('pfPhotoInput').value = ''; 
            };
            reader.readAsDataURL(file);
        }

        // Adiciona o listener para o campo de upload
        document.addEventListener('DOMContentLoaded', () => {
            const pfInput = document.getElementById('pfPhotoInput');
            if(pfInput) {
                pfInput.addEventListener('change', handleAvatarUpload);
            }
        });


        // ------------------ CARIMBO DIGITAL (CANVAS) ------------------

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const btnGenerate = document.getElementById('btnGenerate');
        const btnQuick = document.getElementById('btnQuick');

        if (btnGenerate) btnGenerate.addEventListener('click', () => generateStamp(false));
        if (btnQuick) btnQuick.addEventListener('click', () => generateStamp(true));

        function setStampButtonsEnabled(enabled) {
            btnGenerate.disabled = !enabled;
            btnQuick.disabled = !enabled;
            btnGenerate.textContent = enabled ? 'Com sua foto no parque' : 'Processando...';
            btnQuick.textContent = enabled ? 'Com imagem do parque' : 'Aguarde...';
        }

        function generateStamp(quick) {
            if (!currentPark) return alert('Erro: Abra um parque antes.');
            const profile = loadProfile();
            const file = document.getElementById('photoInput').files[0];
            const errorEl = document.getElementById('errorStamp');
            errorEl.style.display = 'none';

            if (!quick && !file) {
                errorEl.textContent = 'Selecione uma foto ou use o modo Quick (Hero).';
                errorEl.style.display = 'block';
                return;
            }

            setStampButtonsEnabled(false);

            const img = new Image();
            img.crossOrigin = 'anonymous'; // Necessário para imagens externas
            img.onload = () => {

                // Dimensões do Canvas (Proporção 4:5 - Vertical para Instagram)
                canvas.width = 960;
                canvas.height = 1200;
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Desenha a imagem de capa (crop centralizado)
                const ratio = Math.max(canvas.width / img.width, canvas.height / img.height);
                const w = img.width * ratio, h = img.height * ratio;
                const x = (canvas.width - w) / 2, y = (canvas.height - h) / 2;
                ctx.drawImage(img, x, y, w, h);

                // Overlay inferior (para texto)
                ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                ctx.fillRect(0, 1020, canvas.width, 180);

                // NOVO: Ícone de Check-in (Selo Verde)
                ctx.fillStyle = '#17A589'; // Cor Primary (Verde)
                ctx.font = '700 40px "Lato"'; // Tamanho do ícone
                ctx.textAlign = 'left';
                ctx.fillText('✅', 40, 1070); // Y = 1070 (Posiciona o ícone verde na esquerda)

                // Texto: Nome do Parque (Agora um pouco mais à direita do ícone e ligeiramente abaixo)
                ctx.fillStyle = '#fff';
                ctx.font = '700 45px "Lato"';
                ctx.textAlign = 'left';
                ctx.fillText(currentPark.name, 90, 1075); // X = 90 (ao lado do ícone), Y = 1075

                // Texto: Localização e Perfil (Descido um pouco para dar espaço)
                ctx.font = '400 24px "Open Sans"';
                ctx.fillText(`📍 ${currentPark.city} | 📸 ${profile.name}`, 40, 1140); // Y = 1140 (Alterado 👣 para 📸)


                // Badge do Avatar (Círculo)
                const cx = canvas.width - 100, cy = 1110, r = 60;
                ctx.beginPath();
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.arc(cx, cy, r, 0, Math.PI * 2);
                ctx.fill();
                ctx.closePath();

                // LÓGICA DE DESENHO ASSÍNCRONO DA FOTO DO PERFIL OU EMOJI
                if (profile.avatarImage) {
                    const profileImg = new Image();
                    profileImg.crossOrigin = 'anonymous'; // CORREÇÃO CORS

                    profileImg.onload = () => {
                        // Desenha a imagem cortada como um círculo (máscara)
                        ctx.save();
                        ctx.beginPath();
                        ctx.arc(cx, cy, r - 2, 0, Math.PI * 2, true);
                        ctx.clip();

                        // Cálculo para centralizar a imagem
                        const imgRatio = Math.max((r * 2) / profileImg.width, (r * 2) / profileImg.height);
                        const imgW = profileImg.width * imgRatio;
                        const imgH = profileImg.height * imgRatio;
                        const imgX = cx - imgW / 2;
                        const imgY = cy - imgH / 2;
                        
                        ctx.drawImage(profileImg, imgX, imgY, imgW, imgH);
                        
                        ctx.restore();
                        
                        // Finaliza (chama o download)
                        finalizeStampGeneration();
                    };
                    profileImg.onerror = () => {
                        // Em caso de falha no carregamento, desenha o emoji
                        drawAvatarEmoji(cx, cy); // Passa cx e cy
                        finalizeStampGeneration();
                    }
                    profileImg.src = profile.avatarImage;
                } else {
                    // Se não houver foto, desenha o emoji e finaliza
                    drawAvatarEmoji(cx, cy); // Passa cx e cy
                    finalizeStampGeneration();
                }

            }; // Fim do img.onload
            
            img.onerror = () => {
                errorEl.textContent = 'Erro ao carregar a imagem. Verifique a URL (CORS) ou tente outra foto.';
                errorEl.style.display = 'block';
                setStampButtonsEnabled(true);
            };

            // Define a origem da imagem
            if (quick || !file) {
                img.src = currentPark.hero;
            } else {
                img.src = URL.createObjectURL(file);
            }
        }

        // Funções auxiliares movidas para fora da generateStamp
        function drawAvatarEmoji(cx, cy) {
            const profile = loadProfile();
            
            // Desenha o fallback (ícone '📸' na posição central do avatar)
            ctx.fillStyle = 'var(--color-primary)';
            ctx.font = '700 40px "Lato"';
            ctx.textAlign = 'center';
            ctx.fillText(profile.avatar || '📸', cx, cy + 15);
        }

        function finalizeStampGeneration() {
            const profile = loadProfile();
            const currentPark = allParks.find(p => p.id === localStorage.getItem('currentParkId')); 

            // Segurança: Se o parque não for encontrado (nunca deve ocorrer), paramos
            if (!currentPark) {
                setStampButtonsEnabled(true);
                return;
            }

            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const stamps = JSON.parse(localStorage.getItem('explorerStamps') || '[]').slice();
                const entry = { id: Date.now(), parkId: currentPark.id, parkName: currentPark.name, ts: new Date().toISOString(), url };
                stamps.push(entry);
                localStorage.setItem('explorerStamps', JSON.stringify(stamps));

                refreshMyStamps();
                setStampButtonsEnabled(true);

                // Auto-download e Share
                const a = document.createElement('a');
                a.href = url;
                a.download = currentPark.id + '-carimbo.png';
                a.click();
                
                if (navigator.share) {
                    fetch(url).then(r => r.blob()).then(b => {
                        const f = new File([b], currentPark.id + '-carimbo.png', { type: 'image/png' });
                        navigator.share({ files: [f], title: 'Check-in: ' + currentPark.name, text: profile.name + ' carimbou sua aventura!' }).catch(() => {});
                    });
                }
            }, 'image/png');
        }


        function refreshMyStamps() {
            const container = document.getElementById('myStamps');
            const stampLabel = document.getElementById('stampLabel');
            container.innerHTML = '';
            const stamps = JSON.parse(localStorage.getItem('explorerStamps') || '[]').slice().reverse();

            if (stamps.length === 0) {
                container.innerHTML = '<p class="text-muted">Comece sua coleção!</p>';
                stampLabel.textContent = 'Nenhum check-in ainda.';
                return;
            }

            // Atualiza o último check-in
            const lastStamp = stamps[0];
            const date = new Date(lastStamp.ts).toLocaleDateString('pt-BR');
            stampLabel.innerHTML = `**${lastStamp.parkName}** (${date})`;

            // Histórico
            stamps.forEach(s => {
                const d = document.createElement('div');
                d.className = 'history-item';
                d.innerHTML = `
                    <img src="${s.url}" alt="Carimbo">
                    <div>
                        <strong>${s.parkName}</strong>
                        <div class="text-muted">${new Date(s.ts).toLocaleDateString('pt-BR')}</div>
                    </div>
                `;
                container.appendChild(d);
            });
        }

        // ------------------ MAPA PRINCIPAL (MY MAPS) ------------------

        // Coloca o mapa inicial de MG
        document.getElementById('mapFrame').src = 'https://www.google.com/maps/d/embed?mid=1wh7GxT4BGPTMWEfc1UI_R9yhgosw4dQ&ehbc=2E312F';


        document.getElementById('useMyMapsBtn').addEventListener('click', () => {
            const url = prompt('Cole aqui o link de incorporação (iframe) do seu Google My Maps:\n(Deve ser uma URL longa começando com https://www.google.com/maps/embed/...)');
            if (url) {
                document.getElementById('mapFrame').src = url;
                alert('Novo mapa carregado!');
            }
        });

        // ------------------ INICIALIZAÇÃO ------------------

        (async function init() {
            // Inicializa Perfil
            if (!localStorage.getItem('explorerProfile')) saveProfileObj(defaultProfile);
            
            // Carrega Parques e Renderiza
            await loadParks();
            renderList(allParks);
            
            // Corrige avatar e carimbos
            applyProfile();
            refreshMyStamps(); 
        })();

    </script>
</script>
</body>
</html>
