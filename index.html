<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Trilhas de Minas: Guia Interativo dos Parques Estaduais</title>
    <meta name="description" content="Guia e Diário de Bordo Digital para os Parques Estaduais de Minas Gerais. Crie seu carimbo, faça check-ins e explore o ecoturismo mineiro." />

    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@700;900&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* 1. Variáveis & Reset */
        :root {
            --color-primary: #17A589; /* Verde Floresta */
            --color-secondary: #0B6B9A; /* Azul Rio */
            --color-background: #F8F9FA;
            --color-text: #212529;
            --color-muted: #6C757D;
            --color-card: #FFFFFF;
            --color-shadow: rgba(23, 165, 137, 0.1);
            --border-radius-lg: 16px;
            --border-radius-sm: 8px;
            --font-family-header: 'Lato', sans-serif;
            --font-family-body: 'Open Sans', sans-serif;
        }

        *{box-sizing: border-box; margin: 0; padding: 0;}
        body {
            font-family: var(--font-family-body);
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 16px;
        }
        
        /* 2. Tipografia e Títulos */
        h1, h2, h3, h4 {
            font-family: var(--font-family-header);
            margin-bottom: 10px;
            color: var(--color-secondary);
        }
        h1 {font-size: 24px;}
        h2 {font-size: 20px;}
        h3 {font-size: 18px;}
        .text-muted {color: var(--color-muted); font-size: 14px;}

/* 3. Componentes Básicos (Botões e Inputs) - NOVO ESTILO MODERNO */
.btn {
    padding: 12px 20px; /* Mais padding */
    border-radius: var(--border-radius-sm);
    border: none; /* Remove a borda padrão */
    font-weight: 700; /* Mais peso na fonte */
    cursor: pointer;
    transition: all 0.2s ease-in-out, transform 0.1s;
    font-size: 14px;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Sombra externa suave */
    position: relative;
    overflow: hidden; /* Para o efeito de hover */
}
/* Efeito de click "3D" */
.btn:active {
    transform: translateY(1px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}
.btn-primary {
    background: var(--color-primary);
    color: var(--color-card);
    /* Adiciona um gradiente e sombra interna sutil (Neumorfismo/3D) */
    box-shadow: 0 4px 10px var(--color-shadow), inset 0 2px 5px rgba(255, 255, 255, 0.2), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
}
.btn-primary:hover {
    background: #148f77; /* Cor mais escura para hover */
}
.btn-secondary {
    background: var(--color-card);
    color: var(--color-secondary); /* Cor secundária mais presente */
    border: 2px solid var(--color-secondary); /* Borda mais grossa */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}
.btn-secondary:hover {
    background: #f0f0f0;
}
.btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    filter: grayscale(1);
    transform: none; /* Desativa o efeito de click */
}

/* INPUTS: Apenas garantindo que o input file não herde estilo de botão */
.input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
}
input[type="text"], textarea { /* input[type="file"] removido daqui para o novo bloco abaixo */
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: var(--border-radius-sm);
    flex-grow: 1;
    font-family: var(--font-family-body);
    transition: border-color 0.2s;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); /* Sombra interna para profundidade */;
    width: 100%
}
input[type="text"]:focus, textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(23, 165, 137, 0.2);
}

/* 8. Estilo Moderno de Upload (File Input) - NOVO */
.file-upload-wrapper {
    position: relative;
    overflow: hidden;
    display: inline-block;
    flex-grow: 1;
}
.file-upload-wrapper input[type="file"] {
    /* Esconde o input file padrão, mas mantém a funcionalidade */
    position: absolute;
    left: 0;
    top: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
    z-index: 5;
}
.file-upload-label {
    /* Estiliza o novo 'botão' que vai substituir o input file */
    display: block;
    width: 100%;
    text-align: center;
    padding: 12px 20px;
    background: var(--color-background);
    color: var(--color-primary);
    border: 2px dashed var(--color-primary);
    border-radius: var(--border-radius-sm);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
}
.file-upload-label:hover {
    background: #e9f5f2;
}

        /* 4. Header e Perfil (FAB) */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 16px;
        }
        .logo-box {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-icon {
            width: 40px; height: 40px;
            border-radius: 8px;
            background: var(--color-primary);
            color: var(--color-card);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
        }
        .profile-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--color-card);
            padding: 6px 10px 6px 6px;
            border-radius: 50px;
            box-shadow: 0 2px 5px var(--color-shadow);
            cursor: pointer;
        }
        .profile-avatar {
            width: 30px; height: 30px;
            border-radius: 50%;
            background: var(--color-secondary);
            color: var(--color-card);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
        }
        /* NOVO: Estilos para o Avatar no Header quando tem foto */
        .profile-avatar.has-image {
            font-size: 0; /* Esconde o emoji */
            background-image: var(--avatar-img); /* Variável setada no JS */
            background-size: cover;
            background-position: center;
        }
        .profile-name {font-weight: 700; font-size: 13px;}

        /* 5. Seção de Busca e Filtro */
        .search-area {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .filter-buttons {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        .filter-buttons .btn {
            flex-shrink: 0;
            background: #fff;
            color: var(--color-muted);
            border: 1px solid #ccc;
        }
        .filter-buttons .btn.active {
            background: var(--color-primary);
            color: var(--color-card);
            border-color: var(--color-primary);
        }

        /* 6. Lista de Parques (Grid) */
        .parks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        .park-card {
            background: var(--color-card);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: 0 4px 12px var(--color-shadow);
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .park-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px var(--color-shadow);
        }
        .card-thumb {
            height: 180px;
            overflow: hidden;
        }
        .card-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .card-content {
            padding: 15px;
        }
        .card-content h3 {
            margin-bottom: 5px;
            color: var(--color-primary);
        }
        .card-details {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--color-muted);
            margin-top: 8px;
        }

        /* 7. Modal (Diário de Bordo) */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: flex-end; /* Mobile-first: abre de baixo */
            z-index: 1000;
        }
        .modal.open {
            display: flex;
        }
        .modal-content {
            background: var(--color-card);
            width: 100%;
            max-width: 900px;
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
            padding: 20px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        @media (min-width: 768px) {
            .modal { align-items: center; } /* Desktop: abre no centro */
            .modal-content { border-radius: var(--border-radius-lg); animation: fadeIn 0.3s; }
            .park-details-grid {
                display: grid;
                grid-template-columns: 2fr 1fr; /* Conteúdo principal + Sidebar */
                gap: 30px;
            }
        }
        @keyframes slideIn {
            from {transform: translateY(100%);}
            to {transform: translateY(0);}
        }
        @keyframes fadeIn {
            from {opacity: 0; transform: scale(0.95);}
            to {opacity: 1; transform: scale(1);}
        }

        /* Detalhes do Modal */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-hero {
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: var(--border-radius-sm);
            margin-bottom: 15px;
        }
        .gallery-strip {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .gallery-strip img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .gallery-strip img:hover {
            border-color: var(--color-primary);
        }
        .map-embed-box {
            height: 300px;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            border: 1px solid #ddd;
            margin-top: 10px;
        }
        .map-embed-box iframe {
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* Sidebar Social (Carimbo) */
        .sidebar-stamp {
            padding: 15px;
            border-radius: var(--border-radius-lg);
            background: #f0f7f5; /* Fundo suave para destaque */
        }
        .stamp-preview {
            text-align: center;
            margin: 15px 0;
        }
        .stamp-badge {
            width: 70px; height: 70px;
            background: var(--color-primary);
            color: var(--color-card);
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            font-weight: 700;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stamp-status {
            font-size: 13px;
            margin-top: 5px;
            color: var(--color-secondary);
            font-weight: 600;
        }
        .stamp-history {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 5px;
        }
        .history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 13px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 5px;
        }
        .history-item img {
            width: 50px;
            height: 35px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="logo-box">
                <div class="logo-icon">⛰️</div>
                <h1>Trilhas de Minas</h1>
            </div>
            <div id="profileBtn" class="profile-pill" onclick="openProfile()">
                <div id="avatarEl" class="profile-avatar">👣</div>
                <div class="profile-name" id="profileName">Visitante</div>
            </div>
        </header>

        <div class="search-area">
            <input type="text" id="q" placeholder="Buscar parque, cidade ou tipo de trilha..." />
            <button class="btn btn-primary" id="btnSearch">Buscar</button>
        </div>

        <div class="filter-buttons" id="parksFilters">
            <button class="btn active" data-filter="all">Todos os Parques</button>
            <button class="btn" data-filter="Fácil">Fácil 🟢</button>
            <button class="btn" data-filter="Médio">Médio 🟡</button>
            <button class="btn" data-filter="Difícil">Difícil 🔴</button>
            <button class="btn" data-filter="Cachoeira">Cachoeiras 💧</button>
            <button class="btn" data-filter="Gruta">Grutas 🦇</button>
        </div>

        <h2 style="margin-top: 20px;">Mapa da Aventura</h2>
        <p class="text-muted" style="margin-bottom: 15px;"></p>
        <div class="map-embed-box" style="height: 350px;">
            <iframe id="mapFrame" src="about:blank" allowfullscreen></iframe>
        </div>

        
        <h2 style="margin-top: 30px;">Próximos Destinos</h2>
        <div id="loadingMessage" class="text-muted" style="text-align: center; padding: 20px;">Carregando trilhas...</div>
        <div id="noResults" class="text-muted" style="text-align: center; padding: 20px; display:none;">Nenhuma trilha encontrada com seus filtros.</div>
        <div id="parksList" class="parks-grid">
            </div>
        
        <footer style="margin-top: 50px; text-align: center;" class="text-muted">
            <p>Trilhas de Minas © Protótipo Serverless | Desenvolvido com foco em performance e ecoturismo.</p>
        </footer>

    </div>

<div id="modalProfile" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Perfil</h3>
            <button class="btn btn-secondary" onclick="closeProfile()">Fechar</button>
        </div>
        
        <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
            <div style="flex-grow: 1;">
                <p class="text-muted" style="margin-bottom: 12px;">Seu nome e foto para o carimbo digital.</p>
                
                <div class="input-group" style="margin-bottom: 12px;">
                    <input type="text" id="pfName" placeholder="Seu Apelido de Aventureiro"/> 
                    <input type="text" id="pfCity" placeholder="Cidade (Opcional)"/>
                </div>
                
                <div class="file-upload-wrapper" style="margin-bottom: 12px;"> 
                    <input type="file" id="pfPhotoInput" accept="image/*" />
                    <label for="pfPhotoInput" class="file-upload-label" id="pfPhotoLabel">
                        📷 Selecionar Foto de Perfil
                    </label>
                </div>
                
                <img id="pfPhotoPreview" style="display:none; width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;" alt="Prévia da foto de perfil" />
                
                <div class="input-group" style="margin-top: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="saveProfile()">Salvar Perfil</button>
                    <button class="btn btn-secondary" onclick="exportProfile()">Exportar</button>
                </div>
                
                </div>
        </div>
    </div>
</div>

    <div id="modalPark" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 id="parkTitle">Título do Parque</h2>
                    <p class="text-muted" id="parkMeta">Cidade | Dificuldade | Tempo Estimado</p>
                </div>
                <button class="btn btn-secondary" onclick="closePark()">Fechar</button>
            </div>
            
            <img id="parkHero" class="modal-hero" src="" alt="Imagem principal do parque">

            <div class="park-details-grid">
                <div>
                    <h4 style="margin-top: 20px;">Galeria de Imagens</h4>
                    <div id="parkGallery" class="gallery-strip"></div>

                    <h4>Sobre o Parque</h4>
                    <p class="text-muted" id="parkAbout"></p>              

                    <h4 style="margin-top: 20px;">Trilhas | Atrações</h4>
                    <p id="parkTrailsInfo" style="white-space: pre-wrap; margin-bottom: 10px;"></p>
                    <p class="text-muted" id="parkMapMsg">Mapa detalhado do parque. Ideal para ver trilhas e pontos de interesse.</p>
                    <div class="map-embed-box">
                        <iframe id="parkDetailMap" src="about:blank" title="Mapa do Parque"></iframe>
                    </div>
                </div>

                <div class="sidebar-stamp">
                    <h4>Carimbo Digital (Check-in)</h4>
                    <p class="text-muted">Gere seu carimbo personalizado com a foto da sua aventura para compartilhar nas redes sociais!</p>
                    
                    <div class="input-group" style="flex-direction: column;">
<div class="file-upload-wrapper">
    <input type="file" id="photoInput" accept="image/*" />
    <label for="photoInput" class="file-upload-label" id="photoInputLabel">
        📸 Escolher Foto da Aventura (Opcional)
    </label>
</div>
                        <span class="text-muted" id="errorStamp" style="color: #c0392b; display: none;"></span>
                        <div class="input-group" style="margin-bottom: 0;">
                            <button class="btn btn-primary" id="btnGenerate">Com sua foto no parque</button>
                            <button class="btn btn-secondary" id="btnQuick">Com imagem do parque</button>
                        </div>
                    </div>
                    
                    <h5 style="margin-top: 20px; color: var(--color-secondary);">Seu Último Check-in</h5>
                    <div class="stamp-preview">
                        <div class="stamp-badge" id="stampBadge">👣</div>
                        <p class="stamp-status" id="stampLabel">Nenhum check-in ainda.</p>
                    </div>

                    <h5 style="margin-top: 20px; color: var(--color-secondary);">Histórico de Carimbos</h5>
                    <div id="myStamps" class="stamp-history">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="canvas" style="display:none"></canvas>

<script>
    // Dados do Projeto - Simulação de JSON
    // **********************************************************************************
    // GUIA RÁPIDO PARA INSERÇÃO DE PARQUES:
    // 
    // 1. COMEÇA AQUI: {
    // 2. id:           'novo_parque', // (string, SEM ACENTOS, SEM ESPAÇOS - Ex: 'rio_doce')
    // 3. name:         'Nome Completo do Parque',
    // 4. city:         'Cidade Sede',
    // 5. difficulty:   'Fácil' | 'Médio' | 'Difícil', // Usado para filtro de cor principal
    // 6. time:         'Tempo Estimado (Ex: 3-4h)',
    // 7. tags:         ['Difícil', 'Cachoeira', 'Mirante'], // Tags usadas nos botões de filtro.
    // 8. hero:         'LINK_DA_FOTO_DE_CAPA_AQUI', // URL da imagem principal (card/modal)
    // 9. about:        'Descrição curta e atraente para o modal.',
    // 10. gallery:     ['LINK_FOTO_1', 'LINK_FOTO_2'], // URLs de miniaturas para a Galeria
    // 11. mapEmbedUrl: 'SUA_URL_DO_MY_MAPS_DE_TRILHAS_AQUI' // URL de incorporação do Google My Maps
    // 12. TERMINA AQUI: },
    // 
    // **********************************************************************************

    const RAW_PARKS_DATA = [
        // --- PARQUE 1: BIRIBIRI (Exemplo de Parque Médio) ---
        { 
            id: 'biribiri', 
            name: 'Parque Estadual do Biribiri', 
            city: 'Diamantina', 
            difficulty: 'Médio', 
            time: '2-8h', 
            tags: ['Médio', 'Cachoeira', 'Mirante', 'Pintura rupestre', 'Vila do Biribiri'],
            trails_info: `O parque possui diversas trilhas, dentre elas as mais visitadas são as trilhas da Sentinela, dos Cristais e do Caminho dos Escravos. As trilhas da Sentinela e dos Cristais possuem 5km e 9km de extensão, respectivamente, e iniciam-se na portaria do parque, porém com traçado distinto da estrada. Apresentam um grau médio de dificuldade. Elas são bem sinalizadas e, portanto, não há necessidade de guia. O caminho dos escravos trata-se de uma passagem construída no século XVIII para possibilitar o escoamento da produção de diamantes da região. O caminho inicia-se no centro de Diamantina e finaliza no distrito de Mendanha, com extensão total de 20km. O trecho no interior do parque é de aproximadamente 16km de extensão. Parte deste caminho foi calçado por escravos e próximo a trilha existem diversos poços e cachoeiras. Recomenda-se o acompanhamento de guia.`, 
            hero: 'https://sisema07.github.io/parquesdeminas/Biribiri-Portaria.png', 
            about: 'Localizado na porção central da Serra do Espinhaço, região que foi reconhecida como Reserva da Biosfera, pela Unesco em 2005. Inserido no bioma do Cerrado, o Parque possui fauna e flora bastante diversificada sendo que muitas de suas espécies estão entre aquelas consideradas ameaçadas de extinção, tais como: lobo-guará, sussuarana, veado, sempre-vivas, orquídeas, bromélias, canelas-de-ema, dentre outras. Nos locais de afloramento rochoso, com altitude acima dos 900 metros em relação ao nível do mar, há ocorrência da fitofisionomia de campos rupestres que se destacam, por exemplo, pela ocorrência marcante de sempre-vivas e canelas-de-ema.', 
            gallery: ['https://sisema07.github.io/parquesdeminas/Biribiri-Portaria.png', 'https://ief.mg.gov.br/documents/51853/7580733/Cachoeira_dos_cristais/4e1537c7-9598-79cd-886a-83a55edc83e4', 'https://ief.mg.gov.br/documents/51853/7580733/cachoeira_Sentinela/2083d28a-4b08-78c6-4939-6344d30ce28f', 'https://ief.mg.gov.br/documents/51853/7580733/Parque_Estadual_do_Biribiri_-_Cachoeira_Sentinela/55dbf035-ddaa-89ad-4eb7-713a7e286a70', 'https://ief.mg.gov.br/documents/51853/7580733/Biribiri/813d84e3-fd2d-71ed-d4b1-8f480b609242', 'https://ief.mg.gov.br/documents/51853/7580733/DSC_7828/c556eba4-7871-362f-1085-d822186120cd', 'https://ief.mg.gov.br/documents/51853/7580733/IMG_7242/72372610-5314-b41d-4e07-1443fec4c8d2'], 
            mapEmbedUrl: ''
        },
        // --- PARQUE 2: IBITIPOCA (Exemplo de Parque Difícil) ---
        { 
            id: 'ibitipoca', 
            name: 'Parque Estadual do Ibitipoca', 
            city: 'Lima Duarte e Santa Rita do Ibitipoca', 
            difficulty: 'Difícil', 
            time: '4-6h', 
            tags: ['Difícil', 'Cachoeira', 'Mirante'], 
            trails_info: `Circuito das Águas: Com 5,2km ida/volta e duração média de 5h, subidas e descidas íngremes. Ao longo da trilha existem mirantes que foram instalados como forma de promover segurança e conforto ao visitante, além de possibilitar a contemplação da paisagem. | Circuito do Pião: Este circuito possui um percurso longo, com aproximadamente 9,5km ida/volta e duração média de 6h, com muitas subidas e descidas íngremes. | Circuito Janela do Céu: Esse circuito tem o limite para receber até 240 visitantes ao dia. É um percurso mais longo, com 16km ida/volta, com subidas e decidas íngremes, que exige preparo físico por conta de sua duração. | Cachoeira dos Macacos: Perfeita para banho em águas | Cachoeira do Encanto Um refúgio natural para relaxar`,
            hero: 'https://ief.mg.gov.br/documents/51853/7558585/Portaria/5e2a35cd-67d1-d786-6aa9-d2a67a718e7f',
            about: 'Localizado nos municípios de Lima Duarte e Santa Rita do Ibitipoca, fazendo divisa com Bias Fortes, o Parque Estadual do Ibitipoca é um dos mais famosos destinos de ecoturismo de Minas Gerais. Inserido no bioma Mata Atlântica, apresenta lagos, cachoeiras, grutas e mirantes impressionantes. Entre os atrativos principais estão a Ponte de Pedra, a Janela do Céu, o Pico do Pião e a Gruta dos Três Arcos. A biodiversidade local reúne espécies raras e ameaçadas. A visitação é controlada, com venda de ingressos online ou diretamente na bilheteria, garantindo preservação ambiental e qualidade da experiência. Suas trilhas bem estruturadas fazem do parque um destino ímpar para contato com a natureza, turismo de aventura e contemplação.',  
            gallery: ['https://ief.mg.gov.br/documents/51853/7558585/Portaria/5e2a35cd-67d1-d786-6aa9-d2a67a718e7f', 'https://ief.mg.gov.br/documents/51853/7558585/Cruzeiro/6bd95b8e-d877-98e8-ac9e-4b860873c272', 'https://ief.mg.gov.br/documents/51853/7558585/Janela-do-ceu/6892d04e-dcfe-def2-84b1-3437c048ca81', 'https://ief.mg.gov.br/documents/51853/7558585/Gruta/471193b8-42d7-cda0-5ed8-e406ce340b2b', 'https://ief.mg.gov.br/documents/51853/7558585/Trilha/e47c2c8d-f354-0c82-da16-66cd096ae338', 'https://ief.mg.gov.br/documents/51853/7558585/Centro_de_Visitantes/03ace2fb-c03e-6f57-bdf2-59753934e974'], 
            mapEmbedUrl: 'https://www.google.com/maps/d/embed?mid=1WU17wqpnnKkLxRN9ldTy0zGaf_fX_8Q&ehbc=2E312F'
        },
        // --- PARQUE 3: Itacolomi (Exemplo de Parque Médio) ---
        { 
            id: 'itacolomi', 
            name: 'Parque Estadual do Itacolomi', 
            city: 'Ouro Preto e Mariana', 
            difficulty: 'Médio', 
            time: '2-8h', 
            tags: ['Médio', 'Cachoeira', 'Vegetação'],
            trails_info: `O parque conta com diversas trilhas, como a Trilha do Pico do Itacolomi, com 6 km de extensão (a partir do Centro de Visitantes), que leva 4 horas (ida e volta) em dificuldade Média para Alta e oferece uma vista de 360º de Ouro Preto e serras. A Trilha dos Sentidos é curta, dura cerca de 40 minutos e proporciona uma aventura sensorial, exigindo agendamento prévio. A Trilha do Forno tem 1.200 metros, dura aproximadamente 1 hora, é de acesso fácil e abriga no final as ruínas de um antigo forno. A Trilha da Capela, com 1.400 metros, também dura cerca de 1 hora e tem acesso fácil, iniciando ao lado da Capela de São José e mostrando diferentes vegetações. A Trilha da Lagoa possui 450 metros, dura 20 minutos e circunda a área da Lagoa da Capela, sendo de acesso fácil. A Trilha do Mirante do Custódio tem 6 km, leva 3 horas (ida e volta) com dificuldade Baixa a Média, e avista a Represa do Custódio. Por fim, a Trilha do Mirante do Morro do Cachorro tem 2 km (ida e volta), leva 1h30min, é de dificuldade Média e permite avistar Ouro Preto, Mariana e outras serras.`, 
            hero: 'https://ief.mg.gov.br/documents/51853/7558741/Portaria/8e0b84fb-cdfc-39d0-f76f-76654d3fdc24', 
            about: 'O parque abriga o Pico do Itacolomi, com 1.772 metros de altitude, que era ponto de referência para os antigos viajantes da Estrada Real, como o bandeirante paulista Antônio Dias, que o chamava de “Farol dos Bandeirantes”. A palavra itacolomy vem da língua tupi e significa “pedra menino”, os índios viam o pico como o “filhote” da montanha ou “pedra mãe”. A Fazenda São José do Manso, no interior da unidade, era um pólo produtor de chá na primeira metade do século 20, e um exemplar da arquitetura colonial deixado pelos bandeirantes em Minas. Suas matas predominam as quaresmeiras e candeias ao longo dos rios e córregos. Nas partes mais elevadas, aparecem os campos de altitude com afloramentos rochosos, onde se destacam as gramíneas e canelas de emas. Abriga muitas nascentes, escondidas nas matas, que deságuam, em sua maioria, no rio Gualaxo do Sul, afluente do rio Doce. Os mais importantes são os córregos do Manso, dos Prazeres, Domingos e do Benedito, o rio Acima e o ribeirão Belchior. Diversas espécies de animais raros e ameaçados de extinção podem ser encontradas na unidade de conservação, como o lobo guará, a ave-pavó, a onça parda e o andorinhão de coleira (ave migratória). Também podem ser vistas espécies de macacos, micos, tatus, pacas, capivaras e gatos mouriscos. Levantamentos identificaram mais de 200 espécies de aves, como jacus, siriemas e beija-flores.', 
            gallery: ['https://ief.mg.gov.br/documents/51853/7558741/Portaria/8e0b84fb-cdfc-39d0-f76f-76654d3fdc24', 'https://ief.mg.gov.br/documents/51853/7558741/casa-bandeirista/6ef259c4-1e3a-233c-3f96-bee0a5dc01a1', 'https://ief.mg.gov.br/documents/51853/7558741/centro_visitantes/be8bfaff-c67e-03e5-4330-ba62705ff847', 'https://ief.mg.gov.br/documents/51853/7558741/trilha-bicicleta/8d4f9876-906b-0e43-5b6a-fd5c346d85be', 'https://ief.mg.gov.br/documents/51853/7558741/Pico_do_Itacolomi/620babcf-2c5e-8d7a-685f-13993f750b24', 'https://ief.mg.gov.br/documents/51853/7558741/Pico_visto_OP/c5460de9-1257-2a70-1d15-53becf55f5b5', 'https://ief.mg.gov.br/documents/51853/7558741/camping01/35924228-b6b2-14de-1e58-4aad3a51878e'], 
            mapEmbedUrl: 'SUA_URL_MYMAPS_CIPÓ_AQUI'
        },
        // --- PARQUE 3: SUMIDOURO (Exemplo de Parque Fácil com Gruta) ---
        { 
            id: 'sumidouro', 
            name: 'Parque Estadual do Sumidouro', 
            city: 'Lagoa Santa', 
            difficulty: 'Fácil', 
            time: '2h', 
            tags: ['Fácil', 'Gruta', 'Arqueologia'], 
            hero: 'https://images.unsplash.com/photo-1549414207-6955c45f4c58?q=80&w=800', 
            about: 'Combina história e natureza, abrigando a Gruta da Lapinha e vestígios arqueológicos de Luzia. Ideal para um passeio leve e cultural.', 
            gallery: ['https://images.unsplash.com/photo-1549414207-6955c45f4c58?q=80&w=800', 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=800'], 
            mapEmbedUrl: 'SUA_URL_MYMAPS_SUMIDOURO_AQUI'
        },
        // --- PARQUE 4: RIO DOCE (Novo Exemplo: Maior remanescente de Mata Atlântica) ---
        { 
            id: 'rio_doce', 
            name: 'Parque Estadual do Rio Doce', 
            city: 'Marliéria', 
            difficulty: 'Médio', 
            time: '3-5h', 
            tags: ['Médio', 'Lago', 'Mata Atlântica', 'Vida Selvagem'], 
            hero: 'https://images.unsplash.com/photo-1582260273766-3d2b27a3c3d5?q=80&w=800', 
            about: 'O maior remanescente de Mata Atlântica de Minas, famoso por seus lagos naturais e pela rica biodiversidade. Ótimo para observação de aves.', 
            gallery: ['https://images.unsplash.com/photo-1582260273766-3d2b27a3c3d5?q=80&w=800', 'https://images.unsplash.com/photo-1547781708-4179371d34c1?q=80&w=800'], 
            mapEmbedUrl: 'SUA_URL_MYMAPS_RIO_DOCE_AQUI'
        },
        // --- PARQUE 5: MANGABEIRAS (Novo Exemplo: Parque Urbano/Fácil) ---
        { 
            id: 'mangabeiras', 
            name: 'Parque das Mangabeiras', 
            city: 'Belo Horizonte', 
            difficulty: 'Fácil', 
            time: '1-2h', 
            tags: ['Fácil', 'Urbano', 'Mirante', 'Família'], 
            hero: 'https://images.unsplash.com/photo-1582260273766-3d2b27a3c3d5?q=80&w=800', 
            about: 'Localizado aos pés da Serra do Curral, este é um dos maiores e mais importantes parques urbanos do país, oferecendo vistas panorâmicas da cidade.', 
            gallery: ['https://images.unsplash.com/photo-1547781708-4179371d34c1?q=80&w=800', 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=800'], 
            mapEmbedUrl: 'SUA_URL_MYMAPS_MANGABEIRAS_AQUI'
        }
    ];
    let allParks = [];

        const THEMED_AVATARS = [
            { type: 'image', value: 'https://sisema07.github.io/parquesdeminas/avatar/Anta.png', name: 'Anta' },
            { type: 'image', value: 'https://sisema07.github.io/parquesdeminas/avatar/Lobo-guará.png', name: 'Lobo-guará' },
            { type: 'image', value: 'https://sisema07.github.io/parquesdeminas/avatar/Onça-parda.png', name: 'Onça-parda' },
            { type: 'image', value: 'https://sisema07.github.io/parquesdeminas/avatar/Quati.png', name: 'Quati' },
            { type: 'image', value: 'https://sisema07.github.io/parquesdeminas/avatar/Tamanduá.png', name: 'Tamanduá' },
            { type: 'image', value: 'https://sisema07.github.io/parquesdeminas/avatar/Tatu.png', name: 'Tatu' },
            { type: 'image', value: 'https://sisema07.github.io/parquesdeminas/avatar/Veado.png', name: 'Veado' }
        ];

    let currentFilter = 'all';

        // Elementos UI
        const parksList = document.getElementById('parksList');
        const loadingMessage = document.getElementById('loadingMessage');
        const noResults = document.getElementById('noResults');
        let currentPark = null;

        // Função de Carregamento (Simulado)
        function loadParks() {
            loadingMessage.style.display = 'block';
            return new Promise(resolve => {
                setTimeout(() => {
                    allParks = RAW_PARKS_DATA;
                    loadingMessage.style.display = 'none';
                    resolve(allParks);
                }, 500);
            });
        }

        // ------------------ RENDERIZAÇÃO E FILTROS ------------------

        function renderList(items) {
            parksList.innerHTML = '';
            noResults.style.display = items.length === 0 ? 'block' : 'none';

            items.forEach(p => {
                const el = document.createElement('div');
                el.className = 'park-card';
                el.dataset.id = p.id;
                el.innerHTML = `
                    <div class="card-thumb"><img src="${p.hero}" alt="Vista de ${p.name}" loading="lazy"></div>
                    <div class="card-content">
                        <h3>${p.name}</h3>
                        <p class="text-muted">${p.about.substring(0, 80)}...</p>
                        <div class="card-details">
                            <span>📍 ${p.city}</span>
                            <span>⏱️ ${p.time}</span>
                            <span>${p.difficulty}</span>
                        </div>
                    </div>
                `;
                el.addEventListener('click', () => openPark(p.id));
                parksList.appendChild(el);
            });
        }

        function doSearch() {
            const q = document.getElementById('q').value.toLowerCase().trim();
            let results = allParks;

            // 1. Filtro de Busca (Nome/Cidade)
            if (q) {
                results = results.filter(p => 
                    p.name.toLowerCase().includes(q) || 
                    p.city.toLowerCase().includes(q) ||
                    p.tags.some(tag => tag.toLowerCase().includes(q)) // Busca por Tags
                );
            }

            // 2. Filtro de Dificuldade/Tag (Botões)
            if (currentFilter !== 'all') {
                results = results.filter(p => p.tags.includes(currentFilter));
            }

            renderList(results);
        }

        // Configuração dos Listeners de Busca e Filtro
        document.getElementById('btnSearch').addEventListener('click', doSearch);
        document.getElementById('q').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') doSearch();
        });

        document.getElementById('parksFilters').querySelectorAll('.btn').forEach(b => {
            b.addEventListener('click', (e) => {
                // Atualiza o estado visual dos botões
                document.getElementById('parksFilters').querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
                e.currentTarget.classList.add('active');
                
                currentFilter = e.currentTarget.dataset.filter;
                doSearch();
            });
        });

        // ------------------ MODAL DE DETALHES DO PARQUE ------------------

        function openPark(id) {
            const p = allParks.find(x => x.id === id);
            if (!p) return;
            currentPark = p;
            localStorage.setItem('currentParkId', p.id); // Salva o ID para uso na finalização assíncrona

            // Preenche o Modal
            document.getElementById('parkTitle').textContent = p.name;
            document.getElementById('parkMeta').textContent = `${p.city} | ${p.difficulty} | ${p.time}`;
            document.getElementById('parkAbout').textContent = p.about;
            document.getElementById('parkHero').src = p.hero;
            document.getElementById('parkTrailsInfo').textContent = p.trails_info || 'Nenhuma informação de trilha detalhada disponível.';
            document.getElementById('parkDetailMap').src = p.mapEmbedUrl || 'about:blank';
            document.getElementById('parkMapMsg').textContent = p.mapEmbedUrl ? 'Visualize as rotas e planeje sua trilha.' : 'Nenhuma rota detalhada disponível. Exibindo mapa geral.';

            // Galeria interativa
            const gallery = document.getElementById('parkGallery');
            gallery.innerHTML = '';
            (p.gallery || []).forEach(u => {
                const img = document.createElement('img');
                img.src = u;
                img.alt = `Miniatura de ${p.name}`;
                img.addEventListener('click', () => document.getElementById('parkHero').src = u);
                gallery.appendChild(img);
            });

            document.getElementById('modalPark').classList.add('open');
            refreshMyStamps(); // Atualiza o histórico de carimbos
        }

        function closePark() {
            document.getElementById('modalPark').classList.remove('open');
        }

        // ------------------ PERFIL E LOCALSTORAGE ------------------


        const defaultProfile = { 
            name: 'Aventureiro', 
            city: '', 
            avatar: null, // MUDANÇA: Era '📸'. Agora é null.
            avatarImage: null // MUDANÇA: Era uma URL. Agora é null.
        };

        function loadProfile() {
            const raw = localStorage.getItem('explorerProfile');
            if (raw) try { return JSON.parse(raw) } catch (e) { }
            return defaultProfile;
        }

        function saveProfileObj(profile) { 
            localStorage.setItem('explorerProfile', JSON.stringify(profile)); 
            applyProfile(); 
        }

        function applyProfile() {
            const p = loadProfile();
            const avatarEl = document.getElementById('avatarEl'); // Elemento no Header
            

            document.getElementById('profileName').textContent = p.name || 'Visitante';
            avatarEl.textContent = p.avatar || ''; // MUDANÇA: Usamos string vazia se não houver avatar
            
            // Lógica para mostrar a imagem no header
            if (p.avatarImage) {
                avatarEl.style.setProperty('--avatar-img', `url(${p.avatarImage})`);
                avatarEl.classList.add('has-image');
            } else {
                avatarEl.style.setProperty('--avatar-img', 'none');
                avatarEl.classList.remove('has-image');
            }
            

        }

        function openProfile() {
            const m = document.getElementById('modalProfile');
            m.classList.add('open');
            const p = loadProfile();
            document.getElementById('pfName').value = p.name !== 'Aventureiro' ? p.name : '';
            document.getElementById('pfCity').value = p.city || '';
            document.getElementById('pfAvatarBig').textContent = p.avatar || '📸';

            // Exibir prévia da imagem e esconder o emoji
            const previewEl = document.getElementById('pfPhotoPreview');
            if (p.avatarImage) {
                previewEl.src = p.avatarImage;
                previewEl.style.display = 'block';
                document.getElementById('pfAvatarBig').textContent = ''; // Esconde o emoji grande
            } else {
                previewEl.style.display = 'none';
                document.getElementById('pfAvatarBig').textContent = p.avatar || '📸'; // Mostra o ícone fallback
            }
            
            // Chama para desenhar a galeria de avatares temáticos
            renderThemedAvatars(); 
        }

        function closeProfile() {
            document.getElementById('modalProfile').classList.remove('open');
        }

        function saveProfile() {
            const name = document.getElementById('pfName').value.trim() || 'Aventureiro';
            const city = document.getElementById('pfCity').value.trim() || '';
            
            // Preserva a imagem e o avatar/emoji atual
            const currentProfile = loadProfile(); 
            const avatar = currentProfile.avatar || '📸';
            const avatarImage = currentProfile.avatarImage || null;
            
            saveProfileObj({ name, city, avatar, avatarImage }); // Salva todos os dados
            closeProfile();
        }
        
        function exportProfile() { /* Lógica de exportação mantida */ } 
        function importProfile() { /* Lógica de importação mantida */ } 
        applyProfile();






        // Lógica para carregar a imagem de perfil e converter para Base64
        function handleAvatarUpload() {
            const file = document.getElementById('pfPhotoInput').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result; // Imagem em Base64
                
                const p = loadProfile();
                p.avatarImage = imageData;
                p.avatar = '📸'; // Usa um emoji de câmera para indicar que há uma foto
                saveProfileObj(p);
                
                // Atualiza o modal de perfil
                const previewEl = document.getElementById('pfPhotoPreview');
                previewEl.src = imageData;
                previewEl.style.display = 'block';
                document.getElementById('pfAvatarBig').textContent = ''; 

                // Limpa o input file para permitir novo upload
                document.getElementById('pfPhotoInput').value = ''; 
            };
            reader.readAsDataURL(file);
        }

// NOVO: Função para atualizar o texto do label do input file
function updateFileInputLabel(inputId, labelId, defaultText, file) {
    const labelEl = document.getElementById(labelId);
    if (!labelEl) return;

    if (file) {
        labelEl.textContent = `✅ Arquivo Selecionado: ${file.name.substring(0, 30)}...`;
        labelEl.style.borderColor = 'var(--color-primary)';
        labelEl.style.color = 'var(--color-primary)';
    } else {
        labelEl.textContent = defaultText;
        labelEl.style.borderColor = '#ddd';
        labelEl.style.color = 'var(--color-muted)';
    }
}

// Adiciona os listeners para o campo de upload (MODIFICADO)
document.addEventListener('DOMContentLoaded', () => {
    // 1. Listener para o campo de upload do Perfil (MODIFICADO)
    const pfInput = document.getElementById('pfPhotoInput');
    if(pfInput) {
        pfInput.addEventListener('change', (e) => {
            // Chama a função que salva o perfil
            handleAvatarUpload(); 
            // Chama a nova função para atualizar o label (Passo 2)
            updateFileInputLabel('pfPhotoInput', 'pfPhotoLabel', '📷 Selecionar Foto de Perfil', e.target.files[0]);
        });
    }

    // 2. Listener para o campo de upload do Check-in (NOVO)
    const photoInput = document.getElementById('photoInput');
    if(photoInput) {
        photoInput.addEventListener('change', (e) => {
            // Chama a nova função para atualizar o label
            updateFileInputLabel('photoInput', 'photoInputLabel', '📸 Escolher Foto da Aventura (Opcional)', e.target.files[0]);
        });
    }
});


        // ------------------ CARIMBO DIGITAL (CANVAS) ------------------

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const btnGenerate = document.getElementById('btnGenerate');
        const btnQuick = document.getElementById('btnQuick');

        if (btnGenerate) btnGenerate.addEventListener('click', () => generateStamp(false));
        if (btnQuick) btnQuick.addEventListener('click', () => generateStamp(true));

        function setStampButtonsEnabled(enabled) {
            btnGenerate.disabled = !enabled;
            btnQuick.disabled = !enabled;
            btnGenerate.textContent = enabled ? 'Com sua foto no parque' : 'Processando...';
            btnQuick.textContent = enabled ? 'Com imagem do parque' : 'Aguarde...';
        }

        function generateStamp(quick) {
            if (!currentPark) return alert('Erro: Abra um parque antes.');
            const profile = loadProfile();
            const file = document.getElementById('photoInput').files[0];
            const errorEl = document.getElementById('errorStamp');
            errorEl.style.display = 'none';

            if (!quick && !file) {
                errorEl.textContent = 'Selecione uma foto ou use o modo Quick (Hero).';
                errorEl.style.display = 'block';
                return;
            }

            setStampButtonsEnabled(false);

            const img = new Image();
            img.crossOrigin = 'anonymous'; // Necessário para imagens externas
            img.onload = () => {

                // Dimensões do Canvas (Proporção 4:5 - Vertical para Instagram)
                canvas.width = 960;
                canvas.height = 1200;
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Desenha a imagem de capa (crop centralizado)
                const ratio = Math.max(canvas.width / img.width, canvas.height / img.height);
                const w = img.width * ratio, h = img.height * ratio;
                const x = (canvas.width - w) / 2, y = (canvas.height - h) / 2;
                ctx.drawImage(img, x, y, w, h);

                // Overlay inferior (para texto)
                ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                ctx.fillRect(0, 1020, canvas.width, 180);

                // NOVO: Ícone de Check-in (Selo Verde)
                ctx.fillStyle = '#17A589'; // Cor Primary (Verde)
                ctx.font = '700 40px "Lato"'; // Tamanho do ícone
                ctx.textAlign = 'left';
                ctx.fillText('✅', 40, 1070); // Y = 1070 (Posiciona o ícone verde na esquerda)

                // Texto: Nome do Parque (Agora um pouco mais à direita do ícone e ligeiramente abaixo)
                ctx.fillStyle = '#fff';
                ctx.font = '700 45px "Lato"';
                ctx.textAlign = 'left';
                ctx.fillText(currentPark.name, 90, 1075); // X = 90 (ao lado do ícone), Y = 1075

                // Texto: Localização e Perfil (Descido um pouco para dar espaço)
                ctx.font = '400 24px "Open Sans"';
                ctx.fillText(`📍 ${currentPark.city} | 📸 ${profile.name}`, 40, 1140); // Y = 1140 (Alterado 👣 para 📸)



// LÓGICA DE DESENHO ASSÍNCRONO DA FOTO DO PERFIL OU AVATAR RANDÔMICO (NOVO BLOCO)

// 1. Definições do Selo/Avatar no Canvas
// REMOVIDO: O bloco que desenhava o círculo branco de fundo foi removido para respeitar a transparência.
const avatarSize = 120; // Diâmetro de 120px (Maior)
const avatarX = canvas.width - 100; // Centro X (Posição)
const avatarY = 1110; // Centro Y (Posição)
const radius = avatarSize / 2;

// 2. Decide a fonte da imagem (Foto de Perfil ou Avatar Aleatório)
const avatarSource = profile.avatarImage 
    ? { url: profile.avatarImage, isProfile: true }
    : (() => {
        // Seleciona um avatar aleatório
        const randomIndex = Math.floor(Math.random() * THEMED_AVATARS.length);
        return { url: THEMED_AVATARS[randomIndex].value, isProfile: false };
    })(); 

const imgAvatar = new Image();
imgAvatar.crossOrigin = 'anonymous'; 

imgAvatar.onload = () => {
    ctx.save();
    
    // Área de Corte (Máscara de Círculo)
    ctx.beginPath();
    ctx.arc(avatarX, avatarY, radius, 0, Math.PI * 2, true); 
    ctx.clip(); // Aplica a máscara de corte

    // Cálculo de Desenho: Centraliza e preenche o círculo
    const imgRatio = Math.max(avatarSize / imgAvatar.width, avatarSize / imgAvatar.height);
    const imgW = imgAvatar.width * imgRatio;
    const imgH = imgAvatar.height * imgRatio;
    const imgX = avatarX - imgW / 2;
    const imgY = avatarY - imgH / 2;
    
    ctx.drawImage(imgAvatar, imgX, imgY, imgW, imgH);

    ctx.restore(); // Restaura o estado para remover a máscara

    // Finaliza a geração do carimbo após o desenho assíncrono
    finalizeStampGeneration();
};
imgAvatar.onerror = () => {
    // Se a foto do perfil ou o avatar randômico falhar, usamos um fallback simples
    console.error('Erro ao carregar avatar/foto. Usando fallback 📸.');
    
    // Desenha um fallback simples no local (como o emoji antigo, mas sem o círculo)
    ctx.fillStyle = 'var(--color-primary)';
    ctx.font = '700 40px "Lato"';
    ctx.textAlign = 'center';
    ctx.fillText('📸', avatarX, avatarY + 15);
    
    finalizeStampGeneration();
}
imgAvatar.src = avatarSource.url; // Inicia o carregamento da imagem

// O restante da função 'generateStamp' é movido para dentro dos 'onload' ou 'onerror'.
return; // Sai da função principal para esperar o carregamento da imagem.

            }; // Fim do img.onload
            
            img.onerror = () => {
                errorEl.textContent = 'Erro ao carregar a imagem. Verifique a URL (CORS) ou tente outra foto.';
                errorEl.style.display = 'block';
                setStampButtonsEnabled(true);
            };

            // Define a origem da imagem
            if (quick || !file) {
                img.src = currentPark.hero;
            } else {
                img.src = URL.createObjectURL(file);
            }
        }



        function finalizeStampGeneration() {
            const profile = loadProfile();
            const currentPark = allParks.find(p => p.id === localStorage.getItem('currentParkId')); 

            // Segurança: Se o parque não for encontrado (nunca deve ocorrer), paramos
            if (!currentPark) {
                setStampButtonsEnabled(true);
                return;
            }

            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const stamps = JSON.parse(localStorage.getItem('explorerStamps') || '[]').slice();
                const entry = { id: Date.now(), parkId: currentPark.id, parkName: currentPark.name, ts: new Date().toISOString(), url };
                stamps.push(entry);
                localStorage.setItem('explorerStamps', JSON.stringify(stamps));

                refreshMyStamps();
                setStampButtonsEnabled(true);

                // Auto-download e Share
                const a = document.createElement('a');
                a.href = url;
                a.download = currentPark.id + '-carimbo.png';
                a.click();
                
                if (navigator.share) {
                    fetch(url).then(r => r.blob()).then(b => {
                        const f = new File([b], currentPark.id + '-carimbo.png', { type: 'image/png' });
                        navigator.share({ files: [f], title: 'Check-in: ' + currentPark.name, text: profile.name + ' carimbou sua aventura!' }).catch(() => {});
                    });
                }
            }, 'image/png');
        }


        function refreshMyStamps() {
            const container = document.getElementById('myStamps');
            const stampLabel = document.getElementById('stampLabel');
            container.innerHTML = '';
            const stamps = JSON.parse(localStorage.getItem('explorerStamps') || '[]').slice().reverse();

            if (stamps.length === 0) {
                container.innerHTML = '<p class="text-muted">Comece sua coleção!</p>';
                stampLabel.textContent = 'Nenhum check-in ainda.';
                return;
            }

            // Atualiza o último check-in
            const lastStamp = stamps[0];
            const date = new Date(lastStamp.ts).toLocaleDateString('pt-BR');
            stampLabel.innerHTML = `**${lastStamp.parkName}** (${date})`;

            // Histórico
            stamps.forEach(s => {
                const d = document.createElement('div');
                d.className = 'history-item';
                d.innerHTML = `
                    <img src="${s.url}" alt="Carimbo">
                    <div>
                        <strong>${s.parkName}</strong>
                        <div class="text-muted">${new Date(s.ts).toLocaleDateString('pt-BR')}</div>
                    </div>
                `;
                container.appendChild(d);
            });
        }

        // ------------------ MAPA PRINCIPAL (MY MAPS) ------------------

        // Coloca o mapa inicial de MG
        document.getElementById('mapFrame').src = 'https://www.google.com/maps/d/embed?mid=1wh7GxT4BGPTMWEfc1UI_R9yhgosw4dQ&ehbc=2E312F';




        // ------------------ INICIALIZAÇÃO ------------------

        (async function init() {
            // Inicializa Perfil
            if (!localStorage.getItem('explorerProfile')) saveProfileObj(defaultProfile);
            
            // Carrega Parques e Renderiza
            await loadParks();
            renderList(allParks);
            
            // Corrige avatar e carimbos
            applyProfile();
            refreshMyStamps(); 
        })();

    </script>
</script>
</body>
</html>
